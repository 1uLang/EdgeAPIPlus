package services

import (
	"encoding/base64"
	"fmt"
	"github.com/1uLang/EdgeCommon/pkg/rpc/pb"
	rpcutils "github.com/TeaOSLab/EdgeAPI/internal/rpc/utils"
	_ "github.com/iwind/TeaGo/bootstrap"
	"github.com/iwind/TeaGo/dbs"
	"github.com/iwind/TeaGo/logs"
	timeutil "github.com/iwind/TeaGo/utils/time"
	"testing"
)

func TestServerService_UploadServerHTTPRequestStat(t *testing.T) {
	dbs.NotifyReady()

	service := new(ServerService)
	_, err := service.UploadServerHTTPRequestStat(rpcutils.NewMockNodeContext(1), &pb.UploadServerHTTPRequestStatRequest{
		Month: timeutil.Format("Ym"),
		RegionCities: []*pb.UploadServerHTTPRequestStatRequest_RegionCity{
			{
				ServerId:      1,
				CountryName:   "中国",
				ProvinceName:  "安徽省",
				CityName:      "阜阳市",
				CountRequests: 1,
			},
		},
		RegionProviders: []*pb.UploadServerHTTPRequestStatRequest_RegionProvider{
			{
				ServerId: 1,
				Name:     "电信",
				Count:    1,
			},
		},
		Systems: []*pb.UploadServerHTTPRequestStatRequest_System{
			{
				ServerId: 1,
				Name:     "Mac OS X",
				Count:    1,
				Version:  "20",
			},
		},
		Browsers: []*pb.UploadServerHTTPRequestStatRequest_Browser{
			{
				ServerId: 1,
				Name:     "Chrome",
				Count:    1,
				Version:  "70",
			},
			{
				ServerId: 1,
				Name:     "Firefox",
				Count:    1,
				Version:  "30",
			},
		},
	})
	if err != nil {
		t.Fatal(err)
	}

	t.Log("===countries===")
	logs.PrintAsJSON(serverHTTPCountryStatMap, t)

	t.Log("===provinces===")
	logs.PrintAsJSON(serverHTTPProvinceStatMap, t)

	t.Log("===cities===")
	logs.PrintAsJSON(serverHTTPCityStatMap, t)

	t.Log("===providers===")
	logs.PrintAsJSON(serverHTTPProviderStatMap, t)

	t.Log("===systems===")
	logs.PrintAsJSON(serverHTTPSystemStatMap, t)

	t.Log("===browsers===")
	logs.PrintAsJSON(serverHTTPBrowserStatMap, t)

	err = service.dumpServerHTTPStats()
	if err != nil {
		t.Fatal(err)
	}
	t.Log("ok")
}

func TestCert(t *testing.T) {
	// 校验
	CertData := []byte(`-----BEGIN CERTIFICATE-----
MIIFLTCCBBWgAwIBAgISAx9STtRL3c4zq/a9HO+C2uosMA0GCSqGSIb3DQEBCwUA
MDIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQD
EwJSMzAeFw0yMzAyMDIxNTU5MzlaFw0yMzA1MDMxNTU5MzhaMBYxFDASBgNVBAMT
C3NzMTIzOTkuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxD/V
Z2kaZeBARJ5BQHYD3jo1ogs5QHjmjcexjLwu0a+d7FG06bzfaXFLl9d6n+jaoERJ
Qfu9FIEl8UZCcziIPmLQhsvRVanxzLLVIgWwShTitei6HRB7nEKYLTczXVH7V6+T
7p+QPRraHunzcYzJO7gU4jT8LP2726PPEC/rDDu5lxMJf3aN+pN+Gw10pb1mbhVl
B58QpZoqPMBOd46ZrTpmNXm8M0fHWZ6346DNPuAteRxtzvq9eWyauSf/4y9cMBsh
qH638U+KLFIJ2bwzQ1cyJ5TPXHt1CU+1WOD+fKfYMe25XxhQng8uI9yw+SxO2n0g
5uY9I+WLUoRQ2REmEwIDAQABo4ICVzCCAlMwDgYDVR0PAQH/BAQDAgWgMB0GA1Ud
JQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAAMB0GA1UdDgQW
BBQvvyj4Z9COyClK6Gq7hxOOJ1sCvzAfBgNVHSMEGDAWgBQULrMXt1hWy65QCUDm
H6+dixTCxjBVBggrBgEFBQcBAQRJMEcwIQYIKwYBBQUHMAGGFWh0dHA6Ly9yMy5v
LmxlbmNyLm9yZzAiBggrBgEFBQcwAoYWaHR0cDovL3IzLmkubGVuY3Iub3JnLzAn
BgNVHREEIDAeggtzczEyMzk5LmNvbYIPd3d3LnNzMTIzOTkuY29tMEwGA1UdIARF
MEMwCAYGZ4EMAQIBMDcGCysGAQQBgt8TAQEBMCgwJgYIKwYBBQUHAgEWGmh0dHA6
Ly9jcHMubGV0c2VuY3J5cHQub3JnMIIBBAYKKwYBBAHWeQIEAgSB9QSB8gDwAHYA
tz77JN+cTbp18jnFulj0bF38Qs96nzXEnh0JgSXttJkAAAGGExHPmQAABAMARzBF
AiB2yQl4ZRI00avXoTV2+IdPmK966ZahPNGB6cQy4wujVgIhAKzq+V2ysEq0eJo0
UiMTWqxHK7E0ORyjoQ50bMJqqewfAHYAejKMVNi3LbYg6jjgUh7phBZwMhOFTTvS
K8E6V6NS61IAAAGGExHRnQAABAMARzBFAiEA4ItbgjCmawaq0wH02BXABgttZrqu
/9v17+ZZ0kOmFTECIFullTkdsMkZi6sykBdkfDCGDq1xtl9EFAX27C4PM77fMA0G
CSqGSIb3DQEBCwUAA4IBAQCiiBb0v1WKyGVqGnd7NaLE+yLyHy4npH57GmHBK2zg
32LJ/K2pHgkxNJMFRy2grZQAn9+sDQt0kYsfJFn4hE/IuMbq13ebv1KLqv3j4Y1I
NA9F/kkavwu61VFHJjUbBOCU+wCd7lFw1vlweAmpVV7pBnpbZ3dUe5s0obPMhSN1
SmZhdgcOB9MnNTjyTKFiVnbKhnClALge8Pods2RQlQfB4edArKsglgsDDYN/xKje
6ktRfnO9yDBrnluzahdtVHieuUJyqj51pi7Fa7KqcY9mZRrb28axb0RufSOwfYZm
hO7X4ZrzK74tLx8pmoDe8xdYtqIsybjYcNyAIcclXQgH
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIFFjCCAv6gAwIBAgIRAJErCErPDBinU/bWLiWnX1owDQYJKoZIhvcNAQELBQAw
TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh
cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMjAwOTA0MDAwMDAw
WhcNMjUwOTE1MTYwMDAwWjAyMQswCQYDVQQGEwJVUzEWMBQGA1UEChMNTGV0J3Mg
RW5jcnlwdDELMAkGA1UEAxMCUjMwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
AoIBAQC7AhUozPaglNMPEuyNVZLD+ILxmaZ6QoinXSaqtSu5xUyxr45r+XXIo9cP
R5QUVTVXjJ6oojkZ9YI8QqlObvU7wy7bjcCwXPNZOOftz2nwWgsbvsCUJCWH+jdx
sxPnHKzhm+/b5DtFUkWWqcFTzjTIUu61ru2P3mBw4qVUq7ZtDpelQDRrK9O8Zutm
NHz6a4uPVymZ+DAXXbpyb/uBxa3Shlg9F8fnCbvxK/eG3MHacV3URuPMrSXBiLxg
Z3Vms/EY96Jc5lP/Ooi2R6X/ExjqmAl3P51T+c8B5fWmcBcUr2Ok/5mzk53cU6cG
/kiFHaFpriV1uxPMUgP17VGhi9sVAgMBAAGjggEIMIIBBDAOBgNVHQ8BAf8EBAMC
AYYwHQYDVR0lBBYwFAYIKwYBBQUHAwIGCCsGAQUFBwMBMBIGA1UdEwEB/wQIMAYB
Af8CAQAwHQYDVR0OBBYEFBQusxe3WFbLrlAJQOYfr52LFMLGMB8GA1UdIwQYMBaA
FHm0WeZ7tuXkAXOACIjIGlj26ZtuMDIGCCsGAQUFBwEBBCYwJDAiBggrBgEFBQcw
AoYWaHR0cDovL3gxLmkubGVuY3Iub3JnLzAnBgNVHR8EIDAeMBygGqAYhhZodHRw
Oi8veDEuYy5sZW5jci5vcmcvMCIGA1UdIAQbMBkwCAYGZ4EMAQIBMA0GCysGAQQB
gt8TAQEBMA0GCSqGSIb3DQEBCwUAA4ICAQCFyk5HPqP3hUSFvNVneLKYY611TR6W
PTNlclQtgaDqw+34IL9fzLdwALduO/ZelN7kIJ+m74uyA+eitRY8kc607TkC53wl
ikfmZW4/RvTZ8M6UK+5UzhK8jCdLuMGYL6KvzXGRSgi3yLgjewQtCPkIVz6D2QQz
CkcheAmCJ8MqyJu5zlzyZMjAvnnAT45tRAxekrsu94sQ4egdRCnbWSDtY7kh+BIm
lJNXoB1lBMEKIq4QDUOXoRgffuDghje1WrG9ML+Hbisq/yFOGwXD9RiX8F6sw6W4
avAuvDszue5L3sz85K+EC4Y/wFVDNvZo4TYXao6Z0f+lQKc0t8DQYzk1OXVu8rp2
yJMC6alLbBfODALZvYH7n7do1AZls4I9d1P4jnkDrQoxB3UqQ9hVl3LEKQ73xF1O
yK5GhDDX8oVfGKF5u+decIsH4YaTw7mP3GFxJSqv3+0lUFJoi5Lc5da149p90Ids
hCExroL1+7mryIkXPeFM5TgO9r0rvZaBFOvV2z0gp35Z0+L4WPlbuEjN/lxPFin+
HlUjr8gRsI3qfJOQFy/9rKIJR0Y/8Omwt/8oTWgy1mdeHmmjk7j1nYsvC9JSQ6Zv
MldlTTKB3zhThV1+XWYp6rjd5JW1zbVWEkLNxE7GJThEUG3szgBVGP7pSWTUTsqX
nLRbwHOoq7hHwg==
-----END CERTIFICATE-----

-----BEGIN CERTIFICATE-----
MIIFYDCCBEigAwIBAgIQQAF3ITfU6UK47naqPGQKtzANBgkqhkiG9w0BAQsFADA/
MSQwIgYDVQQKExtEaWdpdGFsIFNpZ25hdHVyZSBUcnVzdCBDby4xFzAVBgNVBAMT
DkRTVCBSb290IENBIFgzMB4XDTIxMDEyMDE5MTQwM1oXDTI0MDkzMDE4MTQwM1ow
TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh
cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwggIiMA0GCSqGSIb3DQEB
AQUAA4ICDwAwggIKAoICAQCt6CRz9BQ385ueK1coHIe+3LffOJCMbjzmV6B493XC
ov71am72AE8o295ohmxEk7axY/0UEmu/H9LqMZshftEzPLpI9d1537O4/xLxIZpL
wYqGcWlKZmZsj348cL+tKSIG8+TA5oCu4kuPt5l+lAOf00eXfJlII1PoOK5PCm+D
LtFJV4yAdLbaL9A4jXsDcCEbdfIwPPqPrt3aY6vrFk/CjhFLfs8L6P+1dy70sntK
4EwSJQxwjQMpoOFTJOwT2e4ZvxCzSow/iaNhUd6shweU9GNx7C7ib1uYgeGJXDR5
bHbvO5BieebbpJovJsXQEOEO3tkQjhb7t/eo98flAgeYjzYIlefiN5YNNnWe+w5y
sR2bvAP5SQXYgd0FtCrWQemsAXaVCg/Y39W9Eh81LygXbNKYwagJZHduRze6zqxZ
Xmidf3LWicUGQSk+WT7dJvUkyRGnWqNMQB9GoZm1pzpRboY7nn1ypxIFeFntPlF4
FQsDj43QLwWyPntKHEtzBRL8xurgUBN8Q5N0s8p0544fAQjQMNRbcTa0B7rBMDBc
SLeCO5imfWCKoqMpgsy6vYMEG6KDA0Gh1gXxG8K28Kh8hjtGqEgqiNx2mna/H2ql
PRmP6zjzZN7IKw0KKP/32+IVQtQi0Cdd4Xn+GOdwiK1O5tmLOsbdJ1Fu/7xk9TND
TwIDAQABo4IBRjCCAUIwDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAQYw
SwYIKwYBBQUHAQEEPzA9MDsGCCsGAQUFBzAChi9odHRwOi8vYXBwcy5pZGVudHJ1
c3QuY29tL3Jvb3RzL2RzdHJvb3RjYXgzLnA3YzAfBgNVHSMEGDAWgBTEp7Gkeyxx
+tvhS5B1/8QVYIWJEDBUBgNVHSAETTBLMAgGBmeBDAECATA/BgsrBgEEAYLfEwEB
ATAwMC4GCCsGAQUFBwIBFiJodHRwOi8vY3BzLnJvb3QteDEubGV0c2VuY3J5cHQu
b3JnMDwGA1UdHwQ1MDMwMaAvoC2GK2h0dHA6Ly9jcmwuaWRlbnRydXN0LmNvbS9E
U1RST09UQ0FYM0NSTC5jcmwwHQYDVR0OBBYEFHm0WeZ7tuXkAXOACIjIGlj26Ztu
MA0GCSqGSIb3DQEBCwUAA4IBAQAKcwBslm7/DlLQrt2M51oGrS+o44+/yQoDFVDC
5WxCu2+b9LRPwkSICHXM6webFGJueN7sJ7o5XPWioW5WlHAQU7G75K/QosMrAdSW
9MUgNTP52GE24HGNtLi1qoJFlcDyqSMo59ahy2cI2qBDLKobkx/J3vWraV0T9VuG
WCLKTVXkcGdtwlfFRjlBz4pYg1htmf5X6DYO8A4jqv2Il9DjXA6USbW1FzXSLr9O
he8Y4IWS6wY7bCkjCWDcRQJMEhg76fsO3txE+FiYruq9RUWhiF1myv4Q6W+CyBFC
Dfvp7OOGAN6dEOM4+qR9sdjoSYKEBpsr6GtPAQw4dy753ec5
-----END CERTIFICATE-----`)
	KeyData := []byte(`-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDEP9VnaRpl4EBE
nkFAdgPeOjWiCzlAeOaNx7GMvC7Rr53sUbTpvN9pcUuX13qf6NqgRElB+70UgSXx
RkJzOIg+YtCGy9FVqfHMstUiBbBKFOK16LodEHucQpgtNzNdUftXr5Pun5A9Gtoe
6fNxjMk7uBTiNPws/bvbo88QL+sMO7mXEwl/do36k34bDXSlvWZuFWUHnxClmio8
wE53jpmtOmY1ebwzR8dZnrfjoM0+4C15HG3O+r15bJq5J//jL1wwGyGofrfxT4os
UgnZvDNDVzInlM9ce3UJT7VY4P58p9gx7blfGFCeDy4j3LD5LE7afSDm5j0j5YtS
hFDZESYTAgMBAAECggEAeH95WPV/7+2xiHBjQGE2Hs0/ATBDBwM1DPkAW5lwZe+e
1+uTWbFOvD+EWsdD08v18VH8aTdY8a4azfqF8plTjnq97wZWknK2tSlZFHrJs7L/
QRKUtCPawidhqOGr+DDOUxjLjEkNF3fVVgXwJFh9dt2gdQRzkmx5XHNIQHgrqmYt
Z3Wo37BZ2ScT6q/3hAs2FL2e1GVjvKZitWn1AW8Jdw/3AN/GBIb0xU6mOCJhbSiP
EBpVmcvbfqoZgncwKr9V7pzhRJhtRjlMZzaQNILbY4dmCo7ejtsEaOScE9tK6m91
hZNCD3v7HhoOuG2AH5j+cvN+sQrs71fEBdxRbw9bAQKBgQDzrADw6j0qREPbmtVc
jVg7d53zWmZoD66xbNP0Pb7w5Q3Zpii2Z3qRiN9OFLmweKTXq62OUxW1tNsoLBRu
6X2r8NPK257zGRaqtU6XfbP5SKOf7G6OCHoZnc/xpwD38/nReUJ2K02qdBwp+sGa
9bIdyAEs2SoV5MCskvOBe71WmwKBgQDOLZ8ScQfB6JbN2hMHYFfE3lGoUxxpQn1x
Glo388Eiydgtlcmza9VlX/GFp8LQiYB5X6T9FA9xW7CLAJpRjGAmpCJJ3RlEmUZK
2WzAXIWHmpg7FkU+L+k2V//8vqdWMs4xIq10CzCtH4iqrAflLFat/lFLDfqqLyIZ
swsdQ0Op6QKBgDUkfSwNmfte2gHJ+eBufyCxDMSnIZBuYyYU2wD4em0lN2kRYO2v
Eb8tv63SvVCsbx8ONRLGMgToBaf0PRyXVa4rHrWuQjM4dIYUdqh5ZMfoPK9DLDVT
yfVOQqysRHzPO9uge4s0FIMpQX8yTgkSrp7qIL98OT5/HjpE7lB+ASQjAoGBAK4S
zo8fZ1FMMqayTAaaTQAmRAM9yGsGfCqV+T3sS1A34pD6OkWF8bGZg604qr6umQ3g
tsgFu9QVecSiSag4QKXfRiPezIqibjqbv7nZY9PNrmGUt/l9MgVz3ulhfp7EXloV
0SR8nihMy3JttGzFNpnIcpJPxycQjFXuWJ/oPqShAoGBAJeJVKWDIm6MvGjX/t+Q
TZsRCjqR9WFGqHo2gMCNKcX2NyjrXSD0WH+OLruTsSuUVaK17TxEKC0Ik3LMb90J
0/Gm4DPp/9mFHORoShsbF7qOoxCdB2oZIPb9WlCjQR1EKec9PwHOxH2mGTbRcZk1
eyXB2g9bxQR/ZsqOm8Ragi7l
-----END PRIVATE KEY-----`)
	c := base64.StdEncoding.EncodeToString(CertData)
	k := base64.StdEncoding.EncodeToString(KeyData)
	fmt.Println(c)
	fmt.Println(k)
}
